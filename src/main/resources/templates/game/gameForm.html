<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<div layout:fragment="content">

    <div id="wrap">
        <form method="post" enctype="multipart/form-data" th:object="${gameDto}">
            <p class="h2">게임 등록</p>
                <div id="select">
                    <select class="form-select" th:field="*{released}">
                        <option value="RELEASED">출시</option>
                        <option value="UN_RELEASED">미출시</option>
                    </select>
                </div>
            <div>
                <div class="input-group mb-3">
                    <span class="input-group-text">제목</span>
                    <input type="text" th:field="*{gameTitle}" class="form-control" placeholder="제목을 입력해주세요">
                    <p th:if="${#fields.hasErrors('gameTitle')}" th:errors="*{gameTitle}" class="error"></p>
                </div>
            </div>
            <div>
                <div class="input-group mb-3">
                    <span class="input-group-text">개발사</span>
                    <input type="text" th:field="*{developer}" class="form-control" placeholder="개발사를 입력해주세요">
                    <p th:if="${#fields.hasErrors('developer')}" th:errors="*{developer}" class="error"></p>
                </div>
            </div>
            <div>
                <div class="input-group mb-3">
                    <span class="input-group-text">장르</span>
                    <input type="text" th:field="*{genre}" class="form-control" placeholder="장르를 입력해주세요">
                    <p th:if="${#fields.hasErrors('genre')}" th:errors="*{genre}" class="error"></p>
                </div>
            </div>
            <div>
                <div class="input-group mb-3">
                    <span class="input-group-text">플랫폼</span>
                    <input type="text" th:field="*{platform}" class="form-control" placeholder="플랫폼을 입력해주세요">
                    <p th:if="${#fields.hasErrors('platform')}" th:errors="*{platform}" class="error"></p>
                </div>
            </div>
            <div>
                <div class="input-group mb-3">
                    <span class="input-group-text">출시일</span>
                    <input type="text" th:field="*{releaseDate}" class="form-control" placeholder="출시일을 입력해주세요">
                    <p th:if="${#fields.hasErrors('releaseDate')}" th:errors="*{releaseDate}" class="error"></p>
                </div>
            </div>
            <div>
                <div class="input-group">
                    <span class="input-group-text">게임 설명</span>
                    <textarea class="form-control" th:field="*{gameDetail}"></textarea>
                    <p th:if="${#fields.hasErrors('gameDetail')}" th:errors="*{gameDetail}" class="error"></p>
                </div>
            </div>

            <div th:if="${#lists.isEmpty(gameDto.gameImgDtoList)}"> <!-- 게임 이미지 정보를 담고 있는 리스트가 비어있으면 등록을 하는 경우 -->
                <div th:each="num: ${#numbers.sequence(1,5)}">
                    <div class="input-group">
                        <input id="upload1" type="file" class="form-control" name="gameImgFile">
                    </div>
                </div>
            </div>

            <div class="upload" th:if="${not #lists.isEmpty(gameDto.gameImgDtoList)}"> <!-- 게임 이미지 정보를 담고 있는 리스트가 비어있지 않으면 수정하는 경우 -->
                <div th:each="gameDto, status: ${gameDto.gameImgDtoList}">
                    <div class="input-group mb-3">
                        <label class="input-group-text" th:text="${not #strings.isEmpty(gameImgDto.oriImgName)}
                        ? ${gameImgDto.oriImgName} : '게임 이미지' + ${status.index+1}"></label> <!-- 저장된 이미지 정보가 있으면 파일명을 보여줌 -->
                        <input id="upload2" type="file" class="form-control" name="gameImgFile">
                        <input type="hidden" name="gameImgIds" th:value="${gameImgDto.id}">
                    </div>
                </div>
            </div>

            <div th:if="${#strings.isEmpty(gameDto.id)}">
                <button id="btn1" th:formaction="@{/games/admin/create}" type="submit" class="btn btn-dark">저장</button>
            </div>

            <div th:unless="${#strings.isEmpty(gameDto.id)}">
                <button id="btn2" th:formaction="@{'/games/admin/' + ${gameDto.id} }" type="submit" class="btn btn-primary">수정</button>
            </div>

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
    </div>

</div>

<th:block layout:fragment="script">

    <script th:inline="javascript">
        $(document).ready(function(){
            var createError = [[${createError}]]; //등록 실패시 에러 출력
            if(createError != null){
                alert(createError);
            }

            bindDomEvent();

        });

        function bindDomEvent(){
            $(".custom-file-input").on("change", function() {
                var fileName = $(this).val().split("\\").pop();  //이미지 파일명
                var fileExt = fileName.substring(fileName.lastIndexOf(".")+1); // 확장자 추출
                fileExt = fileExt.toLowerCase(); //소문자 변환

                //이미지 파일이 맞는지 검사
                if(fileExt != "jpg" && fileExt != "jpeg" && fileExt != "gif" && fileExt != "png" && fileExt != "bmp"){
                    alert("이미지 파일만 등록이 가능합니다.");
                    return;
                }

                $(this).siblings(".custom-file-label").html(fileName);
            });
        }
    </script>

</th:block>

<th:block layout:fragment="css">

    <style>
        #select{
            margin-top: 20px;
            margin-bottom: 20px;
        }
        #upload1{
            margin-top: 20px;
        }
        #upload2{
            margin-top: 20px;
        }
        .error {
            color: red;
        }
        #wrap{
            max-width: 750px;
            margin: 50px auto;
        }
        #btn1{
            margin-top: 20px;
            float: right;
        }
        #btn2{
            margin-top: 20px;
            float: right;
        }
    </style>
</th:block>

</body>
</html>